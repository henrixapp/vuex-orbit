"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _store = require("@orbit/store");

var _store2 = _interopRequireDefault(_store);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class VuexStore extends _store2.default {
    constructor(settings = {}) {
        super(settings);
        this.namespaced = false;
        if (settings.schema) {
            //generate vuex store
            this.state = this.state || {};
            Object.keys(this._schema.models).forEach(type => {
                let model = settings.schema.getModel(type);
                this.state = this.state || {};
                //add to state
                this.state[this._schema.singularize(type)] = model;
                this.state[this._schema.pluralize(type)] = [];
            });
            //map fields
            this.getters = {
                getField: state => {
                    return path => path.split(/[.[\]]+/).reduce((prev, key) => prev[key], state);
                }
            };
            this.actions = {
                //TODO: Add fetch settings like json api
                create: ({ commit, dispatch }, record) => {
                    this.update(t => t.addRecord(record)).then(data => {
                        dispatch("fetchAllOf", record.type);
                        commit("set", { record, model: this._schema.singularize(record.type) });
                        //TODO: relationships 
                    });
                },
                /**
                 * @argument model: The model as singularized name
                 */
                fetchAllOf: ({ commit }, model) => {
                    this.query(q => q.findRecords(model)).then(data => {
                        commit('set', { data, model: this._schema.pluralize(model) });
                    });
                },
                fetchAllRelatedOf: ({ commit }, query) => {
                    this.query(q => q.findRelatedRecords(query.data, query.relationship)).then(data => {
                        commit('set', { data, model: query.relationship });
                    });
                },
                fetchRelatedOf: ({ commit }, query) => {
                    this.query(q => q.findRelatedRecord(query.data, query.relationship)).then(data => {
                        commit('set', { data, model: query.relationship });
                    });
                },
                fetchOne: ({ commit }, { model, id }) => {
                    this.query(q => q.findRecord({ type: model, id })).then(data => commit('set', { data, model: this._schema.singularize(model) }));
                },
                update: ({ commit }, data) => {
                    this.update(t => t.replaceRecord(data)).then(() => commit('set', { data, model: data.type }));
                },
                delete: ({ commit, dispatch }, data) => {
                    this.update(t => t.removeRecord(data)).then(() => {
                        //update
                        dispatch("fetchAllOf", data.type);
                    });
                }
                //TODO: RelatedRecords update and delete
            };
            this.mutations = {
                set: (state, { data, model }) => {
                    state[model] = data;
                    if (model.lastIndexOf('s') !== model.length - 1) {
                        state[this.schema.pluralize(model)].forEach(item => {
                            if (item.id === data.id) {
                                item.attributes = data.attributes;
                                item.relationships = data.relationships;
                                item.keys = data.keys;
                            }
                        });
                    }
                },
                updateField: (state, { path, value }) => {
                    //set in field
                    path.split(/[.[\]]+/).reduce((prev, key, index, array) => {
                        if (array.length === index + 1) {
                            // eslint-disable-next-line no-param-reassign
                            prev[key] = value;
                        }
                        return prev[key];
                    }, state);
                }
            };
        }
    }
}
exports.default = VuexStore;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZ1ZXgtc3RvcmUuanMiXSwibmFtZXMiOlsiVnVleFN0b3JlIiwiU3RvcmUiLCJjb25zdHJ1Y3RvciIsInNldHRpbmdzIiwibmFtZXNwYWNlZCIsInNjaGVtYSIsInN0YXRlIiwiT2JqZWN0Iiwia2V5cyIsIl9zY2hlbWEiLCJtb2RlbHMiLCJmb3JFYWNoIiwidHlwZSIsIm1vZGVsIiwiZ2V0TW9kZWwiLCJzaW5ndWxhcml6ZSIsInBsdXJhbGl6ZSIsImdldHRlcnMiLCJnZXRGaWVsZCIsInBhdGgiLCJzcGxpdCIsInJlZHVjZSIsInByZXYiLCJrZXkiLCJhY3Rpb25zIiwiY3JlYXRlIiwiY29tbWl0IiwiZGlzcGF0Y2giLCJyZWNvcmQiLCJ1cGRhdGUiLCJ0IiwiYWRkUmVjb3JkIiwidGhlbiIsImRhdGEiLCJmZXRjaEFsbE9mIiwicXVlcnkiLCJxIiwiZmluZFJlY29yZHMiLCJmZXRjaEFsbFJlbGF0ZWRPZiIsImZpbmRSZWxhdGVkUmVjb3JkcyIsInJlbGF0aW9uc2hpcCIsImZldGNoUmVsYXRlZE9mIiwiZmluZFJlbGF0ZWRSZWNvcmQiLCJmZXRjaE9uZSIsImlkIiwiZmluZFJlY29yZCIsInJlcGxhY2VSZWNvcmQiLCJkZWxldGUiLCJyZW1vdmVSZWNvcmQiLCJtdXRhdGlvbnMiLCJzZXQiLCJsYXN0SW5kZXhPZiIsImxlbmd0aCIsIml0ZW0iLCJhdHRyaWJ1dGVzIiwicmVsYXRpb25zaGlwcyIsInVwZGF0ZUZpZWxkIiwidmFsdWUiLCJpbmRleCIsImFycmF5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTs7Ozs7O0FBQ2UsTUFBTUEsU0FBTixTQUF3QkMsZUFBeEIsQ0FBOEI7QUFDekNDLGdCQUFZQyxXQUFXLEVBQXZCLEVBQTJCO0FBQ3ZCLGNBQU1BLFFBQU47QUFDQSxhQUFLQyxVQUFMLEdBQWtCLEtBQWxCO0FBQ0EsWUFBSUQsU0FBU0UsTUFBYixFQUFxQjtBQUNqQjtBQUNBLGlCQUFLQyxLQUFMLEdBQWEsS0FBS0EsS0FBTCxJQUFjLEVBQTNC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QixVQUF2QjtBQUNBRCxxQ0FBS0UsYUFBTCxHQUFxQnRCLEtBQUtzQixhQUExQjtBQUNBRixxQ0FBSzdDLElBQUwsR0FBWXlCLEtBQUt6QixJQUFqQjtBQUNIO0FBQ0oseUJBTkQ7QUFPSDtBQUNKLGlCQVpZO0FBYWJnRCw2QkFBYSxDQUFDbEQsS0FBRCxFQUFRLEVBQUVhLElBQUYsRUFBUXNDLEtBQVIsRUFBUixLQUE0QjtBQUNyQztBQUNBdEMseUJBQUtDLEtBQUwsQ0FBVyxTQUFYLEVBQXNCQyxNQUF0QixDQUE2QixDQUFDQyxJQUFELEVBQU9DLEdBQVAsRUFBWW1DLEtBQVosRUFBbUJDLEtBQW5CLEtBQTZCO0FBQ3RELDRCQUFJQSxNQUFNUCxNQUFOLEtBQWlCTSxRQUFRLENBQTdCLEVBQWdDO0FBQzVCO0FBQ0FwQyxpQ0FBS0MsR0FBTCxJQUFZa0MsS0FBWjtBQUNIO0FBQ0QsK0JBQU9uQyxLQUFLQyxHQUFMLENBQVA7QUFDSCxxQkFORCxFQU1HakIsS0FOSDtBQU9IO0FBdEJZLGFBQWpCO0FBd0JIO0FBQ0o7QUF0RndDO2tCQUF4Qk4sUyIsImZpbGUiOiJ2dWV4LXN0b3JlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFN0b3JlIGZyb20gJ0BvcmJpdC9zdG9yZSc7XG5leHBvcnQgZGVmYXVsdCBjbGFzcyBWdWV4U3RvcmUgZXh0ZW5kcyBTdG9yZSB7XG4gICAgY29uc3RydWN0b3Ioc2V0dGluZ3MgPSB7fSkge1xuICAgICAgICBzdXBlcihzZXR0aW5ncyk7XG4gICAgICAgIHRoaXMubmFtZXNwYWNlZCA9IGZhbHNlO1xuICAgICAgICBpZiAoc2V0dGluZ3Muc2NoZW1hKSB7XG4gICAgICAgICAgICAvL2dlbmVyYXRlIHZ1ZXggc3RvcmVcbiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSB0aGlzLnN0YXRlIHx8IHt9O1xuICAgICAgICAgICAgT2JqZWN0LmtleXModGhpcy5fc2NoZW1hLm1vZGVscykuZm9yRWFjaCh0eXBlID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgbW9kZWwgPSBzZXR0aW5ncy5zY2hlbWEuZ2V0TW9kZWwodHlwZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IHRoaXMuc3RhdGUgfHwge307XG4gICAgICAgICAgICAgICAgLy9hZGQgdG8gc3RhdGVcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlW3RoaXMuX3NjaGVtYS5zaW5ndWxhcml6ZSh0eXBlKV0gPSBtb2RlbDtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlW3RoaXMuX3NjaGVtYS5wbHVyYWxpemUodHlwZSldID0gW107XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIC8vbWFwIGZpZWxkc1xuICAgICAgICAgICAgdGhpcy5nZXR0ZXJzID0ge1xuICAgICAgICAgICAgICAgIGdldEZpZWxkOiBzdGF0ZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXRoID0+IHBhdGguc3BsaXQoL1suW1xcXV0rLykucmVkdWNlKChwcmV2LCBrZXkpID0+IHByZXZba2V5XSwgc3RhdGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLmFjdGlvbnMgPSB7XG4gICAgICAgICAgICAgICAgLy9UT0RPOiBBZGQgZmV0Y2ggc2V0dGluZ3MgbGlrZSBqc29uIGFwaVxuICAgICAgICAgICAgICAgIGNyZWF0ZTogKHsgY29tbWl0LCBkaXNwYXRjaCB9LCByZWNvcmQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGUodCA9PiB0LmFkZFJlY29yZChyZWNvcmQpKS50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGF0Y2goXCJmZXRjaEFsbE9mXCIsIHJlY29yZC50eXBlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1pdChcInNldFwiLCB7IHJlY29yZCwgbW9kZWw6IHRoaXMuX3NjaGVtYS5zaW5ndWxhcml6ZShyZWNvcmQudHlwZSkgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL1RPRE86IHJlbGF0aW9uc2hpcHMgXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgICAgICogQGFyZ3VtZW50IG1vZGVsOiBUaGUgbW9kZWwgYXMgc2luZ3VsYXJpemVkIG5hbWVcbiAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICBmZXRjaEFsbE9mOiAoeyBjb21taXQgfSwgbW9kZWwpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5xdWVyeShxID0+IHEuZmluZFJlY29yZHMobW9kZWwpKS50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29tbWl0KCdzZXQnLCB7IGRhdGEsIG1vZGVsOiB0aGlzLl9zY2hlbWEucGx1cmFsaXplKG1vZGVsKSB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBmZXRjaEFsbFJlbGF0ZWRPZjogKHsgY29tbWl0IH0sIHF1ZXJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucXVlcnkocSA9PiBxLmZpbmRSZWxhdGVkUmVjb3JkcyhxdWVyeS5kYXRhLCBxdWVyeS5yZWxhdGlvbnNoaXApKS50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29tbWl0KCdzZXQnLCB7IGRhdGEsIG1vZGVsOiBxdWVyeS5yZWxhdGlvbnNoaXAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZmV0Y2hSZWxhdGVkT2Y6ICh7IGNvbW1pdCB9LCBxdWVyeSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXJ5KHEgPT4gcS5maW5kUmVsYXRlZFJlY29yZChxdWVyeS5kYXRhLCBxdWVyeS5yZWxhdGlvbnNoaXApKS50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29tbWl0KCdzZXQnLCB7IGRhdGEsIG1vZGVsOiBxdWVyeS5yZWxhdGlvbnNoaXAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZmV0Y2hPbmU6ICh7IGNvbW1pdCB9LCB7IG1vZGVsLCBpZCB9KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucXVlcnkocSA9PiBxLmZpbmRSZWNvcmQoeyB0eXBlOiBtb2RlbCwgaWQgfSkpLnRoZW4oZGF0YSA9PiBjb21taXQoJ3NldCcsIHsgZGF0YSwgbW9kZWw6IHRoaXMuX3NjaGVtYS5zaW5ndWxhcml6ZShtb2RlbCkgfSkpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgdXBkYXRlOiAoeyBjb21taXQgfSwgZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZSh0ID0+IHQucmVwbGFjZVJlY29yZChkYXRhKSkudGhlbigoKSA9PiBjb21taXQoJ3NldCcsIHsgZGF0YSwgbW9kZWw6IGRhdGEudHlwZSB9KSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBkZWxldGU6ICh7IGNvbW1pdCwgZGlzcGF0Y2ggfSwgZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZSh0ID0+IHQucmVtb3ZlUmVjb3JkKGRhdGEpKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vdXBkYXRlXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNwYXRjaChcImZldGNoQWxsT2ZcIiwgZGF0YS50eXBlKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vVE9ETzogUmVsYXRlZFJlY29yZHMgdXBkYXRlIGFuZCBkZWxldGVcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLm11dGF0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICBzZXQ6IChzdGF0ZSwgeyBkYXRhLCBtb2RlbCB9KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlW21vZGVsXSA9IGRhdGE7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtb2RlbC5sYXN0SW5kZXhPZigncycpICE9PSBtb2RlbC5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZVt0aGlzLnNjaGVtYS5wbHVyYWxpemUobW9kZWwpXS5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmlkID09PSBkYXRhLmlkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0uYXR0cmlidXRlcyA9IGRhdGEuYXR0cmlidXRlcztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5yZWxhdGlvbnNoaXBzID0gZGF0YS5yZWxhdGlvbnNoaXBzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLmtleXMgPSBkYXRhLmtleXM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHVwZGF0ZUZpZWxkOiAoc3RhdGUsIHsgcGF0aCwgdmFsdWUgfSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAvL3NldCBpbiBmaWVsZFxuICAgICAgICAgICAgICAgICAgICBwYXRoLnNwbGl0KC9bLltcXF1dKy8pLnJlZHVjZSgocHJldiwga2V5LCBpbmRleCwgYXJyYXkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcnJheS5sZW5ndGggPT09IGluZGV4ICsgMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1wYXJhbS1yZWFzc2lnblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZba2V5XSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByZXZba2V5XTtcbiAgICAgICAgICAgICAgICAgICAgfSwgc3RhdGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICB9XG59Il19