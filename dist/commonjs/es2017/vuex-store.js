'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _store = require('@orbit/store');

var _store2 = _interopRequireDefault(_store);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class VuexStore extends _store2.default {
    constructor(settings = {}) {
        super(settings);
        this.namespaced = false;
        if (settings.schema) {
            //generate vuex store
            this.state = this.state || {};
            Object.keys(this._schema.models).forEach(type => {
                let model = settings.schema.getModel(type);
                this.state = this.state || {};
                //add to state
                //singularized
                this.state[type] = null;
                //and a collection
                this.state[`${type}Collection`] = [];
            });
            //map fields
            this.getters = {
                getField: state => {
                    return path => path.split(/[.[\]]+/).reduce((prev, key) => {
                        if (prev != null) {
                            return prev[key];
                        } else {
                            return null;
                        }
                    }, state);
                }
            };
            this.actions = {
                //TODO: Add fetch settings like json api
                create: async ({ commit }, record) => {
                    let data = await this.update(t => t.addRecord(record));
                    commit("set", { data: record, model: record.type });
                },
                /**
                 * @argument model: The model as singularized name
                 */
                fetchAllOf: ({ commit }, model) => {
                    this.query(q => q.findRecords(model)).then(data => {
                        commit('set', { data, model: `${model}Collection` });
                    });
                },
                fetchAllRelatedOf: ({ commit }, query) => {
                    this.query(q => q.findRelatedRecords(query.data, query.relationship)).then(data => {
                        commit('set', { data, model: query.relationship }); //mind that this is the pluralized version
                    });
                },
                fetchRelatedOf: ({ commit }, query) => {
                    this.query(q => q.findRelatedRecord(query.data, query.relationship)).then(data => {
                        commit('set', { data, model: query.relationship }); //singularized version
                    });
                },
                fetchOne: ({ commit }, { model, id }) => {
                    this.query(q => q.findRecord({ type: model, id })).then(data => commit('set', { data, model: model }));
                },
                update: ({ commit }, data) => {
                    this.update(t => t.updateRecord(data)).then(() => commit('set', { data, model: data.type }));
                },
                delete: ({ commit, dispatch }, data) => {
                    this.update(t => t.removeRecord(data)).then(() => {
                        //update
                        dispatch("fetchAllOf", data.type);
                    });
                },
                updating: (store, options) => {
                    this.update(options.transformOrOperations).then(data => {
                        options.thenable(store, data);
                    });
                },
                querying: (store, options) => {
                    this.query(q => {
                        return options.queryOrExpression(q);
                    }).then(data => {
                        options.thenable(store, data);
                    });
                }
                //TODO: RelatedRecords update and delete
            };
            this.mutations = {
                remove: (state, { data, model }) => {
                    //TODO: singularize
                    if (model.lastIndexOf('s') !== model.length - 1) {
                        let index = state[model + 's'].findIndex(record => record.id == data.id);
                        state[model + 's'].splice(index, 1);
                    } else {
                        let index = state[model + 's'].findIndex(record => record.id == data.id);
                        state[model + 's'].splice(index, 1);
                    }
                },
                set: (state, { data, model }) => {
                    state[model] = data;
                    if (!model.endsWith("Collection")) {
                        //update also in Collection
                        let setted = false;
                        state[`${model}Collection`].forEach(item => {
                            if (item.id === data.id) {
                                item.attributes = data.attributes;
                                item.relationships = data.relationships;
                                item.keys = data.keys;
                                setted = true;
                            }
                        });
                        if (!setted) {
                            state[`${model}Collection`].push(data);
                        }
                    } else {
                        //splice data in oder to achieve updates
                        state[model] = [];
                        state[model] = data;
                        state[model].splice(data.length);
                    }
                },
                updateField: (state, { path, value }) => {
                    //set in field
                    path.split(/[.[\]]+/).reduce((prev, key, index, array) => {
                        if (array.length === index + 1) {
                            // eslint-disable-next-line no-param-reassign
                            prev[key] = value;
                        }
                        return prev[key];
                    }, state);
                }
            };
        }
    }
}
exports.default = VuexStore;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZ1ZXgtc3RvcmUuanMiXSwibmFtZXMiOlsiVnVleFN0b3JlIiwiU3RvcmUiLCJjb25zdHJ1Y3RvciIsInNldHRpbmdzIiwibmFtZXNwYWNlZCIsInNjaGVtYSIsInN0YXRlIiwiT2JqZWN0Iiwia2V5cyIsIl9zY2hlbWEiLCJtb2RlbHMiLCJmb3JFYWNoIiwidHlwZSIsIm1vZGVsIiwiZ2V0TW9kZWwiLCJnZXR0ZXJzIiwiZ2V0RmllbGQiLCJwYXRoIiwic3BsaXQiLCJyZWR1Y2UiLCJwcmV2Iiwia2V5IiwiYWN0aW9ucyIsImNyZWF0ZSIsImNvbW1pdCIsInJlY29yZCIsImRhdGEiLCJ1cGRhdGUiLCJ0IiwiYWRkUmVjb3JkIiwiZmV0Y2hBbGxPZiIsInF1ZXJ5IiwicSIsImZpbmRSZWNvcmRzIiwidGhlbiIsImZldGNoQWxsUmVsYXRlZE9mIiwiZmluZFJlbGF0ZWRSZWNvcmRzIiwicmVsYXRpb25zaGlwIiwiZmV0Y2hSZWxhdGVkT2YiLCJmaW5kUmVsYXRlZFJlY29yZCIsImZldGNoT25lIiwiaWQiLCJmaW5kUmVjb3JkIiwidXBkYXRlUmVjb3JkIiwiZGVsZXRlIiwiZGlzcGF0Y2giLCJyZW1vdmVSZWNvcmQiLCJ1cGRhdGluZyIsInN0b3JlIiwib3B0aW9ucyIsInRyYW5zZm9ybU9yT3BlcmF0aW9ucyIsInRoZW5hYmxlIiwicXVlcnlpbmciLCJxdWVyeU9yRXhwcmVzc2lvbiIsIm11dGF0aW9ucyIsInJlbW92ZSIsImxhc3RJbmRleE9mIiwibGVuZ3RoIiwiaW5kZXgiLCJmaW5kSW5kZXgiLCJzcGxpY2UiLCJzZXQiLCJlbmRzV2l0aCIsInNldHRlZCIsIml0ZW0iLCJhdHRyaWJ1dGVzIiwicmVsYXRpb25zaGlwcyIsInB1c2giLCJ1cGRhdGVGaWVsZCIsInZhbHVlIiwiYXJyYXkiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBOzs7Ozs7QUFDZSxNQUFNQSxTQUFOLFNBQXdCQyxlQUF4QixDQUE4QjtBQUN6Q0MsZ0JBQVlDLFdBQVcsRUFBdkIsRUFBMkI7QUFDdkIsY0FBTUEsUUFBTjtBQUNBLGFBQUtDLFVBQUwsR0FBa0IsS0FBbEI7QUFDQSxZQUFJRCxTQUFTRSxNQUFiLEVBQXFCO0FBQ2pCO0FBQ0EsaUJBQUtDLEtBQUwsR0FBYSxLQUFLQSxLQUFMLElBQWMsRUFBM0I7QUFDQUMsbUJBQU9DLElBQVAsQ0FBWSxLQUFLQyxPQUFMLENBQWFDLE1BQXpCLEVBQWlDQyxPQUFqQyxDQUF5Q0MsUUFBUTtBQUM3QyxvQkFBSUMsUUFBUVYsU0FBU0UsTUFBVCxDQUFnQlMsUUFBaEIsQ0FBeUJGLElBQXpCLENBQVo7QUFDQSxxQkFBS04sS0FBTCxHQUFhLEtBQUtBLEtBQUwsSUFBYyxFQUEzQjtBQUNBO0FBQ0E7QUFDQSxxQkFBS0EsS0FBTCxDQUFXTSxJQUFYLElBQW1CLElBQW5CO0FBQ0E7QUFDQSxxQkFBS04sS0FBTCxDQUFZLEdBQUVNLElBQUssWUFBbkIsSUFBa0MsRUFBbEM7QUFDSCxhQVJEO0FBU0E7QUFDQSxpQkFBS0csT0FBTCxHQUFlO0FBQ1hDLDBCQUFVVixTQUFTO0FBQ2YsMkJBQU9XLFFBQVFBLEtBQUtDLEtBQUwsQ0FBVyxTQUFYLEVBQXNCQyxNQUF0QixDQUE2QixDQUFDQyxJQUFELEVBQU9DLEdBQVAsS0FBZTtBQUN2RCw0QkFBSUQsUUFBUSxJQUFaLEVBQWtCO0FBQ2QsbUNBQU9BLEtBQUtDLEdBQUwsQ0FBUDtBQUNILHlCQUZELE1BRU87QUFDSCxtQ0FBTyxJQUFQO0FBQ0g7QUFDSixxQkFOYyxFQU1aZixLQU5ZLENBQWY7QUFPSDtBQVRVLGFBQWY7QUFXQSxpQkFBS2dCLE9BQUwsR0FBZTtBQUNYO0FBQ0FDLHdCQUFRLE9BQU8sRUFBRUMsTUFBRixFQUFQLEVBQW1CQyxNQUFuQixLQUE4QjtBQUNsQyx3QkFBSUMsT0FBTyxNQUFNLEtBQUtDLE1BQUwsQ0FBWUMsS0FBS0EsRUFBRUMsU0FBRixDQUFZSixNQUFaLENBQWpCLENBQWpCO0FBQ0FELDJCQUFPLEtBQVAsRUFBYyxFQUFFRSxNQUFNRCxNQUFSLEVBQWdCWixPQUFPWSxPQUFPYixJQUE5QixFQUFkO0FBQ0gsaUJBTFU7QUFNWDs7O0FBR0FrQiw0QkFBWSxDQUFDLEVBQUVOLE1BQUYsRUFBRCxFQUFhWCxLQUFiLEtBQXVCO0FBQy9CLHlCQUFLa0IsS0FBTCxDQUFXQyxLQUFLQSxFQUFFQyxXQUFGLENBQWNwQixLQUFkLENBQWhCLEVBQXNDcUIsSUFBdEMsQ0FBMkNSLFFBQVE7QUFDL0NGLCtCQUFPLEtBQVAsRUFBYyxFQUFFRSxJQUFGLEVBQVFiLE9BQVEsR0FBRUEsS0FBTSxZQUF4QixFQUFkO0FBQ0gscUJBRkQ7QUFHSCxpQkFiVTtBQWNYc0IsbUNBQW1CLENBQUMsRUFBRVgsTUFBRixFQUFELEVBQWFPLEtBQWIsS0FBdUI7QUFDdEMseUJBQUtBLEtBQUwsQ0FBV0MsS0FBS0EsRUFBRUksa0JBQUYsQ0FBcUJMLE1BQU1MLElBQTNCLEVBQWlDSyxNQUFNTSxZQUF2QyxDQUFoQixFQUFzRUgsSUFBdEUsQ0FBMkVSLFFBQVE7QUFDL0VGLCtCQUFPLEtBQVAsRUFBYyxFQUFFRSxJQUFGLEVBQVFiLE9BQU9rQixNQUFNTSxZQUFyQixFQUFkLEVBRCtFLENBQzNCO0FBQ3ZELHFCQUZEO0FBR0gsaUJBbEJVO0FBbUJYQyxnQ0FBZ0IsQ0FBQyxFQUFFZCxNQUFGLEVBQUQsRUFBYU8sS0FBYixLQUF1QjtBQUNuQyx5QkFBS0EsS0FBTCxDQUFXQyxLQUFLQSxFQUFFTyxpQkFBRixDQUFvQlIsTUFBTUwsSUFBMUIsRUFBZ0NLLE1BQU1NLFlBQXRDLENBQWhCLEVBQXFFSCxJQUFyRSxDQUEwRVIsUUFBUTtBQUM5RUYsK0JBQU8sS0FBUCxFQUFjLEVBQUVFLElBQUYsRUFBUWIsT0FBT2tCLE1BQU1NLFlBQXJCLEVBQWQsRUFEOEUsQ0FDMUI7QUFDdkQscUJBRkQ7QUFHSCxpQkF2QlU7QUF3QlhHLDBCQUFVLENBQUMsRUFBRWhCLE1BQUYsRUFBRCxFQUFhLEVBQUVYLEtBQUYsRUFBUzRCLEVBQVQsRUFBYixLQUErQjtBQUNyQyx5QkFBS1YsS0FBTCxDQUFXQyxLQUFLQSxFQUFFVSxVQUFGLENBQWEsRUFBRTlCLE1BQU1DLEtBQVIsRUFBZTRCLEVBQWYsRUFBYixDQUFoQixFQUFtRFAsSUFBbkQsQ0FBd0RSLFFBQVFGLE9BQU8sS0FBUCxFQUFjLEVBQUVFLElBQUYsRUFBUWIsT0FBT0EsS0FBZixFQUFkLENBQWhFO0FBQ0gsaUJBMUJVO0FBMkJYYyx3QkFBUSxDQUFDLEVBQUVILE1BQUYsRUFBRCxFQUFhRSxJQUFiLEtBQXNCO0FBQzFCLHlCQUFLQyxNQUFMLENBQVlDLEtBQUtBLEVBQUVlLFlBQUYsQ0FBZWpCLElBQWYsQ0FBakIsRUFBdUNRLElBQXZDLENBQTRDLE1BQU1WLE9BQU8sS0FBUCxFQUFjLEVBQUVFLElBQUYsRUFBUWIsT0FBT2EsS0FBS2QsSUFBcEIsRUFBZCxDQUFsRDtBQUNILGlCQTdCVTtBQThCWGdDLHdCQUFRLENBQUMsRUFBRXBCLE1BQUYsRUFBVXFCLFFBQVYsRUFBRCxFQUF1Qm5CLElBQXZCLEtBQWdDO0FBQ3BDLHlCQUFLQyxNQUFMLENBQVlDLEtBQUtBLEVBQUVrQixZQUFGLENBQWVwQixJQUFmLENBQWpCLEVBQXVDUSxJQUF2QyxDQUE0QyxNQUFNO0FBQzlDO0FBQ0FXLGlDQUFTLFlBQVQsRUFBdUJuQixLQUFLZCxJQUE1QjtBQUNILHFCQUhEO0FBSUgsaUJBbkNVO0FBb0NYbUMsMEJBQVUsQ0FBQ0MsS0FBRCxFQUFRQyxPQUFSLEtBQW9CO0FBQzFCLHlCQUFLdEIsTUFBTCxDQUFZc0IsUUFBUUMscUJBQXBCLEVBQTJDaEIsSUFBM0MsQ0FBZ0RSLFFBQVE7QUFDcER1QixnQ0FBUUUsUUFBUixDQUFpQkgsS0FBakIsRUFBd0J0QixJQUF4QjtBQUNILHFCQUZEO0FBR0gsaUJBeENVO0FBeUNYMEIsMEJBQVUsQ0FBQ0osS0FBRCxFQUFRQyxPQUFSLEtBQW9CO0FBQzFCLHlCQUFLbEIsS0FBTCxDQUFXQyxLQUFLO0FBQ1osK0JBQU9pQixRQUFRSSxpQkFBUixDQUEwQnJCLENBQTFCLENBQVA7QUFDSCxxQkFGRCxFQUVHRSxJQUZILENBRVFSLFFBQVE7QUFDWnVCLGdDQUFRRSxRQUFSLENBQWlCSCxLQUFqQixFQUF3QnRCLElBQXhCO0FBQ0gscUJBSkQ7QUFLSDtBQUNEO0FBaERXLGFBQWY7QUFrREEsaUJBQUs0QixTQUFMLEdBQWlCO0FBQ2JDLHdCQUFRLENBQUNqRCxLQUFELEVBQVEsRUFBRW9CLElBQUYsRUFBUWIsS0FBUixFQUFSLEtBQTRCO0FBQ2hDO0FBQ0Esd0JBQUlBLE1BQU0yQyxXQUFOLENBQWtCLEdBQWxCLE1BQTJCM0MsTUFBTTRDLE1BQU4sR0FBZSxDQUE5QyxFQUFpRDtBQUM3Qyw0QkFBSUMsUUFBUXBELE1BQU1PLFFBQVEsR0FBZCxFQUFtQjhDLFNBQW5CLENBQTZCbEMsVUFBVUEsT0FBT2dCLEVBQVAsSUFBYWYsS0FBS2UsRUFBekQsQ0FBWjtBQUNBbkMsOEJBQU1PLFFBQVEsR0FBZCxFQUFtQitDLE1BQW5CLENBQTBCRixLQUExQixFQUFpQyxDQUFqQztBQUNILHFCQUhELE1BR087QUFDSCw0QkFBSUEsUUFBUXBELE1BQU1PLFFBQVEsR0FBZCxFQUFtQjhDLFNBQW5CLENBQTZCbEMsVUFBVUEsT0FBT2dCLEVBQVAsSUFBYWYsS0FBS2UsRUFBekQsQ0FBWjtBQUNBbkMsOEJBQU1PLFFBQVEsR0FBZCxFQUFtQitDLE1BQW5CLENBQTBCRixLQUExQixFQUFpQyxDQUFqQztBQUNIO0FBQ0osaUJBVlk7QUFXYkcscUJBQUssQ0FBQ3ZELEtBQUQsRUFBUSxFQUFFb0IsSUFBRixFQUFRYixLQUFSLEVBQVIsS0FBNEI7QUFDN0JQLDBCQUFNTyxLQUFOLElBQWVhLElBQWY7QUFDQSx3QkFBSSxDQUFDYixNQUFNaUQsUUFBTixDQUFlLFlBQWYsQ0FBTCxFQUFtQztBQUMvQjtBQUNBLDRCQUFJQyxTQUFTLEtBQWI7QUFDQXpELDhCQUFPLEdBQUVPLEtBQU0sWUFBZixFQUE0QkYsT0FBNUIsQ0FBb0NxRCxRQUFRO0FBQ3hDLGdDQUFJQSxLQUFLdkIsRUFBTCxLQUFZZixLQUFLZSxFQUFyQixFQUF5QjtBQUNyQnVCLHFDQUFLQyxVQUFMLEdBQWtCdkMsS0FBS3VDLFVBQXZCO0FBQ0FELHFDQUFLRSxhQUFMLEdBQXFCeEMsS0FBS3dDLGFBQTFCO0FBQ0FGLHFDQUFLeEQsSUFBTCxHQUFZa0IsS0FBS2xCLElBQWpCO0FBQ0F1RCx5Q0FBUyxJQUFUO0FBQ0g7QUFDSix5QkFQRDtBQVFBLDRCQUFJLENBQUNBLE1BQUwsRUFBYTtBQUNUekQsa0NBQU8sR0FBRU8sS0FBTSxZQUFmLEVBQTRCc0QsSUFBNUIsQ0FBaUN6QyxJQUFqQztBQUNIO0FBQ0oscUJBZEQsTUFjTztBQUNIO0FBQ0FwQiw4QkFBTU8sS0FBTixJQUFlLEVBQWY7QUFDQVAsOEJBQU1PLEtBQU4sSUFBZWEsSUFBZjtBQUNBcEIsOEJBQU1PLEtBQU4sRUFBYStDLE1BQWIsQ0FBb0JsQyxLQUFLK0IsTUFBekI7QUFDSDtBQUNKLGlCQWpDWTtBQWtDYlcsNkJBQWEsQ0FBQzlELEtBQUQsRUFBUSxFQUFFVyxJQUFGLEVBQVFvRCxLQUFSLEVBQVIsS0FBNEI7QUFDckM7QUFDQXBELHlCQUFLQyxLQUFMLENBQVcsU0FBWCxFQUFzQkMsTUFBdEIsQ0FBNkIsQ0FBQ0MsSUFBRCxFQUFPQyxHQUFQLEVBQVlxQyxLQUFaLEVBQW1CWSxLQUFuQixLQUE2QjtBQUN0RCw0QkFBSUEsTUFBTWIsTUFBTixLQUFpQkMsUUFBUSxDQUE3QixFQUFnQztBQUM1QjtBQUNBdEMsaUNBQUtDLEdBQUwsSUFBWWdELEtBQVo7QUFDSDtBQUNELCtCQUFPakQsS0FBS0MsR0FBTCxDQUFQO0FBQ0gscUJBTkQsRUFNR2YsS0FOSDtBQU9IO0FBM0NZLGFBQWpCO0FBNkNIO0FBQ0o7QUE1SHdDO2tCQUF4Qk4sUyIsImZpbGUiOiJ2dWV4LXN0b3JlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFN0b3JlIGZyb20gJ0BvcmJpdC9zdG9yZSc7XG5leHBvcnQgZGVmYXVsdCBjbGFzcyBWdWV4U3RvcmUgZXh0ZW5kcyBTdG9yZSB7XG4gICAgY29uc3RydWN0b3Ioc2V0dGluZ3MgPSB7fSkge1xuICAgICAgICBzdXBlcihzZXR0aW5ncyk7XG4gICAgICAgIHRoaXMubmFtZXNwYWNlZCA9IGZhbHNlO1xuICAgICAgICBpZiAoc2V0dGluZ3Muc2NoZW1hKSB7XG4gICAgICAgICAgICAvL2dlbmVyYXRlIHZ1ZXggc3RvcmVcbiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSB0aGlzLnN0YXRlIHx8IHt9O1xuICAgICAgICAgICAgT2JqZWN0LmtleXModGhpcy5fc2NoZW1hLm1vZGVscykuZm9yRWFjaCh0eXBlID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgbW9kZWwgPSBzZXR0aW5ncy5zY2hlbWEuZ2V0TW9kZWwodHlwZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IHRoaXMuc3RhdGUgfHwge307XG4gICAgICAgICAgICAgICAgLy9hZGQgdG8gc3RhdGVcbiAgICAgICAgICAgICAgICAvL3Npbmd1bGFyaXplZFxuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGVbdHlwZV0gPSBudWxsO1xuICAgICAgICAgICAgICAgIC8vYW5kIGEgY29sbGVjdGlvblxuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGVbYCR7dHlwZX1Db2xsZWN0aW9uYF0gPSBbXTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgLy9tYXAgZmllbGRzXG4gICAgICAgICAgICB0aGlzLmdldHRlcnMgPSB7XG4gICAgICAgICAgICAgICAgZ2V0RmllbGQ6IHN0YXRlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhdGggPT4gcGF0aC5zcGxpdCgvWy5bXFxdXSsvKS5yZWR1Y2UoKHByZXYsIGtleSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByZXYgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwcmV2W2tleV07XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9LCBzdGF0ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMuYWN0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICAvL1RPRE86IEFkZCBmZXRjaCBzZXR0aW5ncyBsaWtlIGpzb24gYXBpXG4gICAgICAgICAgICAgICAgY3JlYXRlOiBhc3luYyAoeyBjb21taXQgfSwgcmVjb3JkKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBkYXRhID0gYXdhaXQgdGhpcy51cGRhdGUodCA9PiB0LmFkZFJlY29yZChyZWNvcmQpKTtcbiAgICAgICAgICAgICAgICAgICAgY29tbWl0KFwic2V0XCIsIHsgZGF0YTogcmVjb3JkLCBtb2RlbDogcmVjb3JkLnR5cGUgfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICAgKiBAYXJndW1lbnQgbW9kZWw6IFRoZSBtb2RlbCBhcyBzaW5ndWxhcml6ZWQgbmFtZVxuICAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgIGZldGNoQWxsT2Y6ICh7IGNvbW1pdCB9LCBtb2RlbCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXJ5KHEgPT4gcS5maW5kUmVjb3Jkcyhtb2RlbCkpLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb21taXQoJ3NldCcsIHsgZGF0YSwgbW9kZWw6IGAke21vZGVsfUNvbGxlY3Rpb25gIH0pO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGZldGNoQWxsUmVsYXRlZE9mOiAoeyBjb21taXQgfSwgcXVlcnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5xdWVyeShxID0+IHEuZmluZFJlbGF0ZWRSZWNvcmRzKHF1ZXJ5LmRhdGEsIHF1ZXJ5LnJlbGF0aW9uc2hpcCkpLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb21taXQoJ3NldCcsIHsgZGF0YSwgbW9kZWw6IHF1ZXJ5LnJlbGF0aW9uc2hpcCB9KTsgLy9taW5kIHRoYXQgdGhpcyBpcyB0aGUgcGx1cmFsaXplZCB2ZXJzaW9uXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZmV0Y2hSZWxhdGVkT2Y6ICh7IGNvbW1pdCB9LCBxdWVyeSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXJ5KHEgPT4gcS5maW5kUmVsYXRlZFJlY29yZChxdWVyeS5kYXRhLCBxdWVyeS5yZWxhdGlvbnNoaXApKS50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29tbWl0KCdzZXQnLCB7IGRhdGEsIG1vZGVsOiBxdWVyeS5yZWxhdGlvbnNoaXAgfSk7IC8vc2luZ3VsYXJpemVkIHZlcnNpb25cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBmZXRjaE9uZTogKHsgY29tbWl0IH0sIHsgbW9kZWwsIGlkIH0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5xdWVyeShxID0+IHEuZmluZFJlY29yZCh7IHR5cGU6IG1vZGVsLCBpZCB9KSkudGhlbihkYXRhID0+IGNvbW1pdCgnc2V0JywgeyBkYXRhLCBtb2RlbDogbW9kZWwgfSkpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgdXBkYXRlOiAoeyBjb21taXQgfSwgZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZSh0ID0+IHQudXBkYXRlUmVjb3JkKGRhdGEpKS50aGVuKCgpID0+IGNvbW1pdCgnc2V0JywgeyBkYXRhLCBtb2RlbDogZGF0YS50eXBlIH0pKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGRlbGV0ZTogKHsgY29tbWl0LCBkaXNwYXRjaCB9LCBkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlKHQgPT4gdC5yZW1vdmVSZWNvcmQoZGF0YSkpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy91cGRhdGVcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BhdGNoKFwiZmV0Y2hBbGxPZlwiLCBkYXRhLnR5cGUpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHVwZGF0aW5nOiAoc3RvcmUsIG9wdGlvbnMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGUob3B0aW9ucy50cmFuc2Zvcm1Pck9wZXJhdGlvbnMpLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnRoZW5hYmxlKHN0b3JlLCBkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBxdWVyeWluZzogKHN0b3JlLCBvcHRpb25zKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucXVlcnkocSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9ucy5xdWVyeU9yRXhwcmVzc2lvbihxKTtcbiAgICAgICAgICAgICAgICAgICAgfSkudGhlbihkYXRhID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMudGhlbmFibGUoc3RvcmUsIGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy9UT0RPOiBSZWxhdGVkUmVjb3JkcyB1cGRhdGUgYW5kIGRlbGV0ZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMubXV0YXRpb25zID0ge1xuICAgICAgICAgICAgICAgIHJlbW92ZTogKHN0YXRlLCB7IGRhdGEsIG1vZGVsIH0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgLy9UT0RPOiBzaW5ndWxhcml6ZVxuICAgICAgICAgICAgICAgICAgICBpZiAobW9kZWwubGFzdEluZGV4T2YoJ3MnKSAhPT0gbW9kZWwubGVuZ3RoIC0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGluZGV4ID0gc3RhdGVbbW9kZWwgKyAncyddLmZpbmRJbmRleChyZWNvcmQgPT4gcmVjb3JkLmlkID09IGRhdGEuaWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGVbbW9kZWwgKyAncyddLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgaW5kZXggPSBzdGF0ZVttb2RlbCArICdzJ10uZmluZEluZGV4KHJlY29yZCA9PiByZWNvcmQuaWQgPT0gZGF0YS5pZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZVttb2RlbCArICdzJ10uc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgc2V0OiAoc3RhdGUsIHsgZGF0YSwgbW9kZWwgfSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBzdGF0ZVttb2RlbF0gPSBkYXRhO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIW1vZGVsLmVuZHNXaXRoKFwiQ29sbGVjdGlvblwiKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy91cGRhdGUgYWxzbyBpbiBDb2xsZWN0aW9uXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgc2V0dGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZVtgJHttb2RlbH1Db2xsZWN0aW9uYF0uZm9yRWFjaChpdGVtID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5pZCA9PT0gZGF0YS5pZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLmF0dHJpYnV0ZXMgPSBkYXRhLmF0dHJpYnV0ZXM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0ucmVsYXRpb25zaGlwcyA9IGRhdGEucmVsYXRpb25zaGlwcztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5rZXlzID0gZGF0YS5rZXlzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXR0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzZXR0ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZVtgJHttb2RlbH1Db2xsZWN0aW9uYF0ucHVzaChkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vc3BsaWNlIGRhdGEgaW4gb2RlciB0byBhY2hpZXZlIHVwZGF0ZXNcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlW21vZGVsXSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGVbbW9kZWxdID0gZGF0YTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlW21vZGVsXS5zcGxpY2UoZGF0YS5sZW5ndGgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB1cGRhdGVGaWVsZDogKHN0YXRlLCB7IHBhdGgsIHZhbHVlIH0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgLy9zZXQgaW4gZmllbGRcbiAgICAgICAgICAgICAgICAgICAgcGF0aC5zcGxpdCgvWy5bXFxdXSsvKS5yZWR1Y2UoKHByZXYsIGtleSwgaW5kZXgsIGFycmF5KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXJyYXkubGVuZ3RoID09PSBpbmRleCArIDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcGFyYW0tcmVhc3NpZ25cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2W2tleV0gPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwcmV2W2tleV07XG4gICAgICAgICAgICAgICAgICAgIH0sIHN0YXRlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgfVxufSJdfQ==