'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _store = require('@orbit/store');

var _store2 = _interopRequireDefault(_store);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class VuexStore extends _store2.default {
    constructor(settings = {}) {
        super(settings);
        this.namespaced = false;
        if (settings.schema) {
            //generate vuex store
            this.state = this.state || {};
            Object.keys(this._schema.models).forEach(type => {
                let model = settings.schema.getModel(type);
                this.state = this.state || {};
                //add to state
                //singularized
                this.state[type] = null;
                //and a collection
                this.state[`${type}Collection`] = [];
            });
            //map fields
            this.getters = {
                getField: state => {
                    return path => path.split(/[.[\]]+/).reduce((prev, key) => {
                        if (prev != null) {
                            return prev[key];
                        } else {
                            return null;
                        }
                    }, state);
                }
            };
            this.actions = {
                //TODO: Add fetch settings like json api
                create: ({ commit, dispatch }, record) => {
                    this.update(t => t.addRecord(record)).then(data => {
                        // dispatch("fetchAllOf", record.type);
                        commit("set", { data: record, model: record.type });
                        //TODO: relationships 
                    });
                },
                /**
                 * @argument model: The model as singularized name
                 */
                fetchAllOf: ({ commit }, model) => {
                    this.query(q => q.findRecords(model)).then(data => {
                        commit('set', { data, model: `${model}Collection` });
                    });
                },
                fetchAllRelatedOf: ({ commit }, query) => {
                    this.query(q => q.findRelatedRecords(query.data, query.relationship)).then(data => {
                        commit('set', { data, model: query.relationship }); //mind that this is the pluralized version
                    });
                },
                fetchRelatedOf: ({ commit }, query) => {
                    this.query(q => q.findRelatedRecord(query.data, query.relationship)).then(data => {
                        commit('set', { data, model: query.relationship }); //singularized version
                    });
                },
                fetchOne: ({ commit }, { model, id }) => {
                    this.query(q => q.findRecord({ type: model, id })).then(data => commit('set', { data, model: model }));
                },
                update: ({ commit }, data) => {
                    this.update(t => t.updateRecord(data)).then(() => commit('set', { data, model: data.type }));
                },
                delete: ({ commit, dispatch }, data) => {
                    this.update(t => t.removeRecord(data)).then(() => {
                        //update
                        dispatch("fetchAllOf", data.type);
                    });
                },
                updating: (store, options) => {
                    this.update(options.transformOrOperations).then(data => {
                        options.thenable(store, data);
                    });
                },
                querying: (store, options) => {
                    this.query(q => {
                        return options.queryOrExpression(q);
                    }).then(data => {
                        options.thenable(store, data);
                    });
                }
                //TODO: RelatedRecords update and delete
            };
            this.mutations = {
                remove: (state, { data, model }) => {
                    if (model.lastIndexOf('s') !== model.length - 1) {
                        let index = state[model + 's'].findIndex(record => record.id == data.id);
                        state[model + 's'].splice(index, 1);
                    } else {
                        let index = state[model + 's'].findIndex(record => record.id == data.id);
                        state[model + 's'].splice(index, 1);
                    }
                },
                set: (state, { data, model }) => {
                    state[model] = data;
                    if (model.endsWith("Collection")) {
                        //update also in Collection
                        let setted = false;
                        state[`${model}Collection`].forEach(item => {
                            if (item.id === data.id) {
                                item.attributes = data.attributes;
                                item.relationships = data.relationships;
                                item.keys = data.keys;
                                setted = true;
                            }
                        });
                        if (!setted) {
                            state[`${model}Collection`].push(data);
                        }
                    } else {
                        //splice data in oder to achieve updates
                        state[model] = [];
                        state[model] = data;
                        state[model].splice(data.length);
                    }
                },
                updateField: (state, { path, value }) => {
                    //set in field
                    path.split(/[.[\]]+/).reduce((prev, key, index, array) => {
                        if (array.length === index + 1) {
                            // eslint-disable-next-line no-param-reassign
                            prev[key] = value;
                        }
                        return prev[key];
                    }, state);
                }
            };
        }
    }
}
exports.default = VuexStore;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZ1ZXgtc3RvcmUuanMiXSwibmFtZXMiOlsiVnVleFN0b3JlIiwiU3RvcmUiLCJjb25zdHJ1Y3RvciIsInNldHRpbmdzIiwibmFtZXNwYWNlZCIsInNjaGVtYSIsInN0YXRlIiwiT2JqZWN0Iiwia2V5cyIsIl9zY2hlbWEiLCJtb2RlbHMiLCJmb3JFYWNoIiwidHlwZSIsIm1vZGVsIiwiZ2V0TW9kZWwiLCJnZXR0ZXJzIiwiZ2V0RmllbGQiLCJwYXRoIiwic3BsaXQiLCJyZWR1Y2UiLCJwcmV2Iiwia2V5IiwiYWN0aW9ucyIsImNyZWF0ZSIsImNvbW1pdCIsImRpc3BhdGNoIiwicmVjb3JkIiwidXBkYXRlIiwidCIsImFkZFJlY29yZCIsInRoZW4iLCJkYXRhIiwiZmV0Y2hBbGxPZiIsInF1ZXJ5IiwicSIsImZpbmRSZWNvcmRzIiwiZmV0Y2hBbGxSZWxhdGVkT2YiLCJmaW5kUmVsYXRlZFJlY29yZHMiLCJyZWxhdGlvbnNoaXAiLCJmZXRjaFJlbGF0ZWRPZiIsImZpbmRSZWxhdGVkUmVjb3JkIiwiZmV0Y2hPbmUiLCJpZCIsImZpbmRSZWNvcmQiLCJ1cGRhdGVSZWNvcmQiLCJkZWxldGUiLCJyZW1vdmVSZWNvcmQiLCJ1cGRhdGluZyIsInN0b3JlIiwib3B0aW9ucyIsInRyYW5zZm9ybU9yT3BlcmF0aW9ucyIsInRoZW5hYmxlIiwicXVlcnlpbmciLCJxdWVyeU9yRXhwcmVzc2lvbiIsIm11dGF0aW9ucyIsInJlbW92ZSIsImxhc3RJbmRleE9mIiwibGVuZ3RoIiwiaW5kZXgiLCJmaW5kSW5kZXgiLCJzcGxpY2UiLCJzZXQiLCJlbmRzV2l0aCIsInNldHRlZCIsIml0ZW0iLCJhdHRyaWJ1dGVzIiwicmVsYXRpb25zaGlwcyIsInB1c2giLCJ1cGRhdGVGaWVsZCIsInZhbHVlIiwiYXJyYXkiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBOzs7Ozs7QUFDZSxNQUFNQSxTQUFOLFNBQXdCQyxlQUF4QixDQUE4QjtBQUN6Q0MsZ0JBQVlDLFdBQVcsRUFBdkIsRUFB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Q3JCc0IscUNBQUtDLFVBQUwsR0FBa0JsQyxLQUFLa0MsVUFBdkI7QUFDQUQscUNBQUtFLGFBQUwsR0FBcUJuQyxLQUFLbUMsYUFBMUI7QUFDQUYscUNBQUt4RCxJQUFMLEdBQVl1QixLQUFLdkIsSUFBakI7QUFDQXVELHlDQUFTLElBQVQ7QUFDSDtBQUNKLHlCQVBEO0FBUUEsNEJBQUksQ0FBQ0EsTUFBTCxFQUFhO0FBQ1R6RCxrQ0FBTyxHQUFFTyxLQUFNLFlBQWYsRUFBNEJzRCxJQUE1QixDQUFpQ3BDLElBQWpDO0FBQ0g7QUFDSixxQkFkRCxNQWNPO0FBQ0g7QUFDQXpCLDhCQUFNTyxLQUFOLElBQWUsRUFBZjtBQUNBUCw4QkFBTU8sS0FBTixJQUFla0IsSUFBZjtBQUNBekIsOEJBQU1PLEtBQU4sRUFBYStDLE1BQWIsQ0FBb0I3QixLQUFLMEIsTUFBekI7QUFDSDtBQUNKLGlCQWhDWTtBQWlDYlcsNkJBQWEsQ0FBQzlELEtBQUQsRUFBUSxFQUFFVyxJQUFGLEVBQVFvRCxLQUFSLEVBQVIsS0FBNEI7QUFDckM7QUFDQXBELHlCQUFLQyxLQUFMLENBQVcsU0FBWCxFQUFzQkMsTUFBdEIsQ0FBNkIsQ0FBQ0MsSUFBRCxFQUFPQyxHQUFQLEVBQVlxQyxLQUFaLEVBQW1CWSxLQUFuQixLQUE2QjtBQUN0RCw0QkFBSUEsTUFBTWIsTUFBTixLQUFpQkMsUUFBUSxDQUE3QixFQUFnQztBQUM1QjtBQUNBdEMsaUNBQUtDLEdBQUwsSUFBWWdELEtBQVo7QUFDSDtBQUNELCtCQUFPakQsS0FBS0MsR0FBTCxDQUFQO0FBQ0gscUJBTkQsRUFNR2YsS0FOSDtBQU9IO0FBMUNZLGFBQWpCO0FBNENIO0FBQ0o7QUE5SHdDO2tCQUF4Qk4sUyIsImZpbGUiOiJ2dWV4LXN0b3JlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFN0b3JlIGZyb20gJ0BvcmJpdC9zdG9yZSc7XG5leHBvcnQgZGVmYXVsdCBjbGFzcyBWdWV4U3RvcmUgZXh0ZW5kcyBTdG9yZSB7XG4gICAgY29uc3RydWN0b3Ioc2V0dGluZ3MgPSB7fSkge1xuICAgICAgICBzdXBlcihzZXR0aW5ncyk7XG4gICAgICAgIHRoaXMubmFtZXNwYWNlZCA9IGZhbHNlO1xuICAgICAgICBpZiAoc2V0dGluZ3Muc2NoZW1hKSB7XG4gICAgICAgICAgICAvL2dlbmVyYXRlIHZ1ZXggc3RvcmVcbiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSB0aGlzLnN0YXRlIHx8IHt9O1xuICAgICAgICAgICAgT2JqZWN0LmtleXModGhpcy5fc2NoZW1hLm1vZGVscykuZm9yRWFjaCh0eXBlID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgbW9kZWwgPSBzZXR0aW5ncy5zY2hlbWEuZ2V0TW9kZWwodHlwZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IHRoaXMuc3RhdGUgfHwge307XG4gICAgICAgICAgICAgICAgLy9hZGQgdG8gc3RhdGVcbiAgICAgICAgICAgICAgICAvL3Npbmd1bGFyaXplZFxuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGVbdHlwZV0gPSBudWxsO1xuICAgICAgICAgICAgICAgIC8vYW5kIGEgY29sbGVjdGlvblxuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGVbYCR7dHlwZX1Db2xsZWN0aW9uYF0gPSBbXTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgLy9tYXAgZmllbGRzXG4gICAgICAgICAgICB0aGlzLmdldHRlcnMgPSB7XG4gICAgICAgICAgICAgICAgZ2V0RmllbGQ6IHN0YXRlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhdGggPT4gcGF0aC5zcGxpdCgvWy5bXFxdXSsvKS5yZWR1Y2UoKHByZXYsIGtleSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByZXYgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwcmV2W2tleV07XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9LCBzdGF0ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMuYWN0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICAvL1RPRE86IEFkZCBmZXRjaCBzZXR0aW5ncyBsaWtlIGpzb24gYXBpXG4gICAgICAgICAgICAgICAgY3JlYXRlOiAoeyBjb21taXQsIGRpc3BhdGNoIH0sIHJlY29yZCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZSh0ID0+IHQuYWRkUmVjb3JkKHJlY29yZCkpLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBkaXNwYXRjaChcImZldGNoQWxsT2ZcIiwgcmVjb3JkLnR5cGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29tbWl0KFwic2V0XCIsIHsgZGF0YTogcmVjb3JkLCBtb2RlbDogcmVjb3JkLnR5cGUgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL1RPRE86IHJlbGF0aW9uc2hpcHMgXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgICAgICogQGFyZ3VtZW50IG1vZGVsOiBUaGUgbW9kZWwgYXMgc2luZ3VsYXJpemVkIG5hbWVcbiAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICBmZXRjaEFsbE9mOiAoeyBjb21taXQgfSwgbW9kZWwpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5xdWVyeShxID0+IHEuZmluZFJlY29yZHMobW9kZWwpKS50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29tbWl0KCdzZXQnLCB7IGRhdGEsIG1vZGVsOiBgJHttb2RlbH1Db2xsZWN0aW9uYCB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBmZXRjaEFsbFJlbGF0ZWRPZjogKHsgY29tbWl0IH0sIHF1ZXJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucXVlcnkocSA9PiBxLmZpbmRSZWxhdGVkUmVjb3JkcyhxdWVyeS5kYXRhLCBxdWVyeS5yZWxhdGlvbnNoaXApKS50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29tbWl0KCdzZXQnLCB7IGRhdGEsIG1vZGVsOiBxdWVyeS5yZWxhdGlvbnNoaXAgfSk7IC8vbWluZCB0aGF0IHRoaXMgaXMgdGhlIHBsdXJhbGl6ZWQgdmVyc2lvblxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGZldGNoUmVsYXRlZE9mOiAoeyBjb21taXQgfSwgcXVlcnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5xdWVyeShxID0+IHEuZmluZFJlbGF0ZWRSZWNvcmQocXVlcnkuZGF0YSwgcXVlcnkucmVsYXRpb25zaGlwKSkudGhlbihkYXRhID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1pdCgnc2V0JywgeyBkYXRhLCBtb2RlbDogcXVlcnkucmVsYXRpb25zaGlwIH0pOyAvL3Npbmd1bGFyaXplZCB2ZXJzaW9uXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZmV0Y2hPbmU6ICh7IGNvbW1pdCB9LCB7IG1vZGVsLCBpZCB9KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucXVlcnkocSA9PiBxLmZpbmRSZWNvcmQoeyB0eXBlOiBtb2RlbCwgaWQgfSkpLnRoZW4oZGF0YSA9PiBjb21taXQoJ3NldCcsIHsgZGF0YSwgbW9kZWw6IG1vZGVsIH0pKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHVwZGF0ZTogKHsgY29tbWl0IH0sIGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGUodCA9PiB0LnVwZGF0ZVJlY29yZChkYXRhKSkudGhlbigoKSA9PiBjb21taXQoJ3NldCcsIHsgZGF0YSwgbW9kZWw6IGRhdGEudHlwZSB9KSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBkZWxldGU6ICh7IGNvbW1pdCwgZGlzcGF0Y2ggfSwgZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZSh0ID0+IHQucmVtb3ZlUmVjb3JkKGRhdGEpKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vdXBkYXRlXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNwYXRjaChcImZldGNoQWxsT2ZcIiwgZGF0YS50eXBlKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB1cGRhdGluZzogKHN0b3JlLCBvcHRpb25zKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlKG9wdGlvbnMudHJhbnNmb3JtT3JPcGVyYXRpb25zKS50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy50aGVuYWJsZShzdG9yZSwgZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgcXVlcnlpbmc6IChzdG9yZSwgb3B0aW9ucykgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXJ5KHEgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnMucXVlcnlPckV4cHJlc3Npb24ocSk7XG4gICAgICAgICAgICAgICAgICAgIH0pLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnRoZW5hYmxlKHN0b3JlLCBkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vVE9ETzogUmVsYXRlZFJlY29yZHMgdXBkYXRlIGFuZCBkZWxldGVcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLm11dGF0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICByZW1vdmU6IChzdGF0ZSwgeyBkYXRhLCBtb2RlbCB9KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtb2RlbC5sYXN0SW5kZXhPZigncycpICE9PSBtb2RlbC5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgaW5kZXggPSBzdGF0ZVttb2RlbCArICdzJ10uZmluZEluZGV4KHJlY29yZCA9PiByZWNvcmQuaWQgPT0gZGF0YS5pZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZVttb2RlbCArICdzJ10uc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpbmRleCA9IHN0YXRlW21vZGVsICsgJ3MnXS5maW5kSW5kZXgocmVjb3JkID0+IHJlY29yZC5pZCA9PSBkYXRhLmlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlW21vZGVsICsgJ3MnXS5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBzZXQ6IChzdGF0ZSwgeyBkYXRhLCBtb2RlbCB9KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlW21vZGVsXSA9IGRhdGE7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtb2RlbC5lbmRzV2l0aChcIkNvbGxlY3Rpb25cIikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vdXBkYXRlIGFsc28gaW4gQ29sbGVjdGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHNldHRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGVbYCR7bW9kZWx9Q29sbGVjdGlvbmBdLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uaWQgPT09IGRhdGEuaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5hdHRyaWJ1dGVzID0gZGF0YS5hdHRyaWJ1dGVzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLnJlbGF0aW9uc2hpcHMgPSBkYXRhLnJlbGF0aW9uc2hpcHM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0ua2V5cyA9IGRhdGEua2V5cztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0dGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2V0dGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGVbYCR7bW9kZWx9Q29sbGVjdGlvbmBdLnB1c2goZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL3NwbGljZSBkYXRhIGluIG9kZXIgdG8gYWNoaWV2ZSB1cGRhdGVzXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZVttb2RlbF0gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlW21vZGVsXSA9IGRhdGE7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZVttb2RlbF0uc3BsaWNlKGRhdGEubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgdXBkYXRlRmllbGQ6IChzdGF0ZSwgeyBwYXRoLCB2YWx1ZSB9KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIC8vc2V0IGluIGZpZWxkXG4gICAgICAgICAgICAgICAgICAgIHBhdGguc3BsaXQoL1suW1xcXV0rLykucmVkdWNlKChwcmV2LCBrZXksIGluZGV4LCBhcnJheSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFycmF5Lmxlbmd0aCA9PT0gaW5kZXggKyAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXBhcmFtLXJlYXNzaWduXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldltrZXldID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJldltrZXldO1xuICAgICAgICAgICAgICAgICAgICB9LCBzdGF0ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgIH1cbn0iXX0=