"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _store = require("@orbit/store");

var _store2 = _interopRequireDefault(_store);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class VuexStore extends _store2.default {
    constructor(settings = {}) {
        super(settings);
        this.namespaced = false;
        if (settings.schema) {
            //generate vuex store
            this.state = this.state || {};
            Object.keys(this._schema.models).forEach(type => {
                let model = settings.schema.getModel(type);
                this.state = this.state || {};
                //add to state
                this.state[this._schema.singularize(type)] = model;
                this.state[this._schema.pluralize(type)] = [];
            });
            //map fields
            this.getters = {
                getField: state => {
                    return path => path.split(/[.[\]]+/).reduce((prev, key) => prev[key], state);
                }
            };
            this.actions = {
                //TODO: Add fetch settings like json api
                create: ({ commit, dispatch }, record) => {
                    this.update(t => t.addRecord(record)).then(data => {
                        dispatch("fetchAllOf", record.type);
                        commit("set", { data: record, model: this._schema.singularize(record.type) });
                        //TODO: relationships 
                    });
                },
                /**
                 * @argument model: The model as singularized name
                 */
                fetchAllOf: ({ commit }, model) => {
                    this.query(q => q.findRecords(model)).then(data => {
                        commit('set', { data, model: this._schema.pluralize(model) });
                    });
                },
                fetchAllRelatedOf: ({ commit }, query) => {
                    this.query(q => q.findRelatedRecords(query.data, query.relationship)).then(data => {
                        commit('set', { data, model: query.relationship });
                    });
                },
                fetchRelatedOf: ({ commit }, query) => {
                    this.query(q => q.findRelatedRecord(query.data, query.relationship)).then(data => {
                        commit('set', { data, model: query.relationship });
                    });
                },
                fetchOne: ({ commit }, { model, id }) => {
                    this.query(q => q.findRecord({ type: model, id })).then(data => commit('set', { data, model: this._schema.singularize(model) }));
                },
                update: ({ commit }, data) => {
                    this.update(t => t.replaceRecord(data)).then(() => commit('set', { data, model: data.type }));
                },
                delete: ({ commit, dispatch }, data) => {
                    this.update(t => t.removeRecord(data)).then(() => {
                        //update
                        dispatch("fetchAllOf", data.type);
                    });
                },
                updating: (store, options) => {
                    this.update(options.transformOrOperations).then(data => {
                        options.thenable(store, data);
                    });
                },
                querying: (store, options) => {
                    this.query(options.queryOrExpression).then(data => {
                        options.thenable(store, data);
                    });
                }
                //TODO: RelatedRecords update and delete
            };
            this.mutations = {
                set: (state, { data, model }) => {
                    state[model] = data;
                    if (model.lastIndexOf('s') !== model.length - 1) {
                        state[this.schema.pluralize(model)].forEach(item => {
                            if (item.id === data.id) {
                                item.attributes = data.attributes;
                                item.relationships = data.relationships;
                                item.keys = data.keys;
                            }
                        });
                    }
                },
                updateField: (state, { path, value }) => {
                    //set in field
                    path.split(/[.[\]]+/).reduce((prev, key, index, array) => {
                        if (array.length === index + 1) {
                            // eslint-disable-next-line no-param-reassign
                            prev[key] = value;
                        }
                        return prev[key];
                    }, state);
                }
            };
        }
    }
}
exports.default = VuexStore;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZ1ZXgtc3RvcmUuanMiXSwibmFtZXMiOlsiVnVleFN0b3JlIiwiU3RvcmUiLCJjb25zdHJ1Y3RvciIsInNldHRpbmdzIiwibmFtZXNwYWNlZCIsInNjaGVtYSIsInN0YXRlIiwiT2JqZWN0Iiwia2V5cyIsIl9zY2hlbWEiLCJtb2RlbHMiLCJmb3JFYWNoIiwidHlwZSIsIm1vZGVsIiwiZ2V0TW9kZWwiLCJzaW5ndWxhcml6ZSIsInBsdXJhbGl6ZSIsImdldHRlcnMiLCJnZXRGaWVsZCIsInBhdGgiLCJzcGxpdCIsInJlZHVjZSIsInByZXYiLCJrZXkiLCJhY3Rpb25zIiwiY3JlYXRlIiwiY29tbWl0IiwiZGlzcGF0Y2giLCJyZWNvcmQiLCJ1cGRhdGUiLCJ0IiwiYWRkUmVjb3JkIiwidGhlbiIsImRhdGEiLCJmZXRjaEFsbE9mIiwicXVlcnkiLCJxIiwiZmluZFJlY29yZHMiLCJmZXRjaEFsbFJlbGF0ZWRPZiIsImZpbmRSZWxhdGVkUmVjb3JkcyIsInJlbGF0aW9uc2hpcCIsImZldGNoUmVsYXRlZE9mIiwiZmluZFJlbGF0ZWRSZWNvcmQiLCJmZXRjaE9uZSIsImlkIiwiZmluZFJlY29yZCIsInJlcGxhY2VSZWNvcmQiLCJkZWxldGUiLCJyZW1vdmVSZWNvcmQiLCJ1cGRhdGluZyIsInN0b3JlIiwib3B0aW9ucyIsInRyYW5zZm9ybU9yT3BlcmF0aW9ucyIsInRoZW5hYmxlIiwicXVlcnlpbmciLCJxdWVyeU9yRXhwcmVzc2lvbiIsIm11dGF0aW9ucyIsInNldCIsImxhc3RJbmRleE9mIiwibGVuZ3RoIiwiaXRlbSIsImF0dHJpYnV0ZXMiLCJyZWxhdGlvbnNoaXBzIiwidXBkYXRlRmllbGQiLCJ2YWx1ZSIsImluZGV4IiwiYXJyYXkiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBOzs7Ozs7QUFDZSxNQUFNQSxTQUFOLFNBQXdCQyxlQUF4QixDQUE4QjtBQUN6Q0MsZ0JBQVlDLFdBQVcsRUFBdkIsRUFBMkI7QUFDdkIsY0FBTUEsUUFBTjtBQUNBLGFBQUtD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YUFBakI7QUF3Qkg7QUFDSjtBQWhHd0M7a0JBQXhCTixTIiwiZmlsZSI6InZ1ZXgtc3RvcmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU3RvcmUgZnJvbSAnQG9yYml0L3N0b3JlJztcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFZ1ZXhTdG9yZSBleHRlbmRzIFN0b3JlIHtcbiAgICBjb25zdHJ1Y3RvcihzZXR0aW5ncyA9IHt9KSB7XG4gICAgICAgIHN1cGVyKHNldHRpbmdzKTtcbiAgICAgICAgdGhpcy5uYW1lc3BhY2VkID0gZmFsc2U7XG4gICAgICAgIGlmIChzZXR0aW5ncy5zY2hlbWEpIHtcbiAgICAgICAgICAgIC8vZ2VuZXJhdGUgdnVleCBzdG9yZVxuICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IHRoaXMuc3RhdGUgfHwge307XG4gICAgICAgICAgICBPYmplY3Qua2V5cyh0aGlzLl9zY2hlbWEubW9kZWxzKS5mb3JFYWNoKHR5cGUgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBtb2RlbCA9IHNldHRpbmdzLnNjaGVtYS5nZXRNb2RlbCh0eXBlKTtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gdGhpcy5zdGF0ZSB8fCB7fTtcbiAgICAgICAgICAgICAgICAvL2FkZCB0byBzdGF0ZVxuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGVbdGhpcy5fc2NoZW1hLnNpbmd1bGFyaXplKHR5cGUpXSA9IG1vZGVsO1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGVbdGhpcy5fc2NoZW1hLnBsdXJhbGl6ZSh0eXBlKV0gPSBbXTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgLy9tYXAgZmllbGRzXG4gICAgICAgICAgICB0aGlzLmdldHRlcnMgPSB7XG4gICAgICAgICAgICAgICAgZ2V0RmllbGQ6IHN0YXRlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhdGggPT4gcGF0aC5zcGxpdCgvWy5bXFxdXSsvKS5yZWR1Y2UoKHByZXYsIGtleSkgPT4gcHJldltrZXldLCBzdGF0ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMuYWN0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICAvL1RPRE86IEFkZCBmZXRjaCBzZXR0aW5ncyBsaWtlIGpzb24gYXBpXG4gICAgICAgICAgICAgICAgY3JlYXRlOiAoeyBjb21taXQsIGRpc3BhdGNoIH0sIHJlY29yZCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZSh0ID0+IHQuYWRkUmVjb3JkKHJlY29yZCkpLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNwYXRjaChcImZldGNoQWxsT2ZcIiwgcmVjb3JkLnR5cGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29tbWl0KFwic2V0XCIsIHsgZGF0YTogcmVjb3JkLCBtb2RlbDogdGhpcy5fc2NoZW1hLnNpbmd1bGFyaXplKHJlY29yZC50eXBlKSB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vVE9ETzogcmVsYXRpb25zaGlwcyBcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICAgKiBAYXJndW1lbnQgbW9kZWw6IFRoZSBtb2RlbCBhcyBzaW5ndWxhcml6ZWQgbmFtZVxuICAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgIGZldGNoQWxsT2Y6ICh7IGNvbW1pdCB9LCBtb2RlbCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXJ5KHEgPT4gcS5maW5kUmVjb3Jkcyhtb2RlbCkpLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb21taXQoJ3NldCcsIHsgZGF0YSwgbW9kZWw6IHRoaXMuX3NjaGVtYS5wbHVyYWxpemUobW9kZWwpIH0pO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGZldGNoQWxsUmVsYXRlZE9mOiAoeyBjb21taXQgfSwgcXVlcnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5xdWVyeShxID0+IHEuZmluZFJlbGF0ZWRSZWNvcmRzKHF1ZXJ5LmRhdGEsIHF1ZXJ5LnJlbGF0aW9uc2hpcCkpLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb21taXQoJ3NldCcsIHsgZGF0YSwgbW9kZWw6IHF1ZXJ5LnJlbGF0aW9uc2hpcCB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBmZXRjaFJlbGF0ZWRPZjogKHsgY29tbWl0IH0sIHF1ZXJ5KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucXVlcnkocSA9PiBxLmZpbmRSZWxhdGVkUmVjb3JkKHF1ZXJ5LmRhdGEsIHF1ZXJ5LnJlbGF0aW9uc2hpcCkpLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb21taXQoJ3NldCcsIHsgZGF0YSwgbW9kZWw6IHF1ZXJ5LnJlbGF0aW9uc2hpcCB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBmZXRjaE9uZTogKHsgY29tbWl0IH0sIHsgbW9kZWwsIGlkIH0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5xdWVyeShxID0+IHEuZmluZFJlY29yZCh7IHR5cGU6IG1vZGVsLCBpZCB9KSkudGhlbihkYXRhID0+IGNvbW1pdCgnc2V0JywgeyBkYXRhLCBtb2RlbDogdGhpcy5fc2NoZW1hLnNpbmd1bGFyaXplKG1vZGVsKSB9KSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB1cGRhdGU6ICh7IGNvbW1pdCB9LCBkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlKHQgPT4gdC5yZXBsYWNlUmVjb3JkKGRhdGEpKS50aGVuKCgpID0+IGNvbW1pdCgnc2V0JywgeyBkYXRhLCBtb2RlbDogZGF0YS50eXBlIH0pKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGRlbGV0ZTogKHsgY29tbWl0LCBkaXNwYXRjaCB9LCBkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlKHQgPT4gdC5yZW1vdmVSZWNvcmQoZGF0YSkpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy91cGRhdGVcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BhdGNoKFwiZmV0Y2hBbGxPZlwiLCBkYXRhLnR5cGUpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHVwZGF0aW5nOiAoc3RvcmUsIG9wdGlvbnMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGUob3B0aW9ucy50cmFuc2Zvcm1Pck9wZXJhdGlvbnMpLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnRoZW5hYmxlKHN0b3JlLCBkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBxdWVyeWluZzogKHN0b3JlLCBvcHRpb25zKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucXVlcnkob3B0aW9ucy5xdWVyeU9yRXhwcmVzc2lvbikudGhlbihkYXRhID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMudGhlbmFibGUoc3RvcmUsIGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy9UT0RPOiBSZWxhdGVkUmVjb3JkcyB1cGRhdGUgYW5kIGRlbGV0ZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMubXV0YXRpb25zID0ge1xuICAgICAgICAgICAgICAgIHNldDogKHN0YXRlLCB7IGRhdGEsIG1vZGVsIH0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGVbbW9kZWxdID0gZGF0YTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGVsLmxhc3RJbmRleE9mKCdzJykgIT09IG1vZGVsLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlW3RoaXMuc2NoZW1hLnBsdXJhbGl6ZShtb2RlbCldLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uaWQgPT09IGRhdGEuaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5hdHRyaWJ1dGVzID0gZGF0YS5hdHRyaWJ1dGVzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLnJlbGF0aW9uc2hpcHMgPSBkYXRhLnJlbGF0aW9uc2hpcHM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0ua2V5cyA9IGRhdGEua2V5cztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgdXBkYXRlRmllbGQ6IChzdGF0ZSwgeyBwYXRoLCB2YWx1ZSB9KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIC8vc2V0IGluIGZpZWxkXG4gICAgICAgICAgICAgICAgICAgIHBhdGguc3BsaXQoL1suW1xcXV0rLykucmVkdWNlKChwcmV2LCBrZXksIGluZGV4LCBhcnJheSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFycmF5Lmxlbmd0aCA9PT0gaW5kZXggKyAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXBhcmFtLXJlYXNzaWduXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldltrZXldID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJldltrZXldO1xuICAgICAgICAgICAgICAgICAgICB9LCBzdGF0ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgIH1cbn0iXX0=