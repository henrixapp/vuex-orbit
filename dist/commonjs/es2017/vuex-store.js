'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _store = require('@orbit/store');

var _store2 = _interopRequireDefault(_store);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class VuexStore extends _store2.default {
    constructor(settings = {}) {
        super(settings);
        this.namespaced = false;
        if (settings.schema) {
            //generate vuex store
            this.state = this.state || {};
            Object.keys(this._schema.models).forEach(type => {
                let model = settings.schema.getModel(type);
                this.state = this.state || {};
                //add to state
                this.state[this._schema.singularize(type)] = null;
                this.state[this._schema.pluralize(type)] = [];
            });
            //map fields
            this.getters = {
                getField: state => {
                    return path => path.split(/[.[\]]+/).reduce((prev, key) => {
                        if (prev != null) {
                            return prev[key];
                        } else {
                            return null;
                        }
                    }, state);
                }
            };
            this.actions = {
                //TODO: Add fetch settings like json api
                create: ({ commit, dispatch }, record) => {
                    this.update(t => t.addRecord(record)).then(data => {
                        // dispatch("fetchAllOf", record.type);
                        commit("set", { data: record, model: this._schema.singularize(record.type) });
                        //TODO: relationships 
                    });
                },
                /**
                 * @argument model: The model as singularized name
                 */
                fetchAllOf: ({ commit }, model) => {
                    this.query(q => q.findRecords(model)).then(data => {
                        commit('set', { data, model: this._schema.pluralize(model) });
                    });
                },
                fetchAllRelatedOf: ({ commit }, query) => {
                    this.query(q => q.findRelatedRecords(query.data, query.relationship)).then(data => {
                        commit('set', { data, model: query.relationship });
                    });
                },
                fetchRelatedOf: ({ commit }, query) => {
                    this.query(q => q.findRelatedRecord(query.data, query.relationship)).then(data => {
                        commit('set', { data, model: query.relationship });
                    });
                },
                fetchOne: ({ commit }, { model, id }) => {
                    this.query(q => q.findRecord({ type: model, id })).then(data => commit('set', { data, model: this._schema.singularize(model) }));
                },
                update: ({ commit }, data) => {
                    this.update(t => t.updateRecord(data)).then(() => commit('set', { data, model: data.type }));
                },
                delete: ({ commit, dispatch }, data) => {
                    this.update(t => t.removeRecord(data)).then(() => {
                        //update
                        dispatch("fetchAllOf", data.type);
                    });
                },
                updating: (store, options) => {
                    this.update(options.transformOrOperations).then(data => {
                        options.thenable(store, data);
                    });
                },
                querying: (store, options) => {
                    this.query(q => {
                        return options.queryOrExpression(q);
                    }).then(data => {
                        options.thenable(store, data);
                    });
                }
                //TODO: RelatedRecords update and delete
            };
            this.mutations = {
                remove: (state, { data, model }) => {
                    if (model.lastIndexOf('s') !== model.length - 1) {
                        let index = state[model + 's'].findIndex(record => record.id == data.id);
                        state[model + 's'].splice(index, 1);
                    } else {
                        let index = state[model + 's'].findIndex(record => record.id == data.id);
                        state[model + 's'].splice(index, 1);
                    }
                },
                set: (state, { data, model }) => {
                    state[model] = data;
                    if (model.lastIndexOf('s') !== model.length - 1) {
                        let setted = false;
                        state[this.schema.pluralize(model)].forEach(item => {
                            if (item.id === data.id) {
                                item.attributes = data.attributes;
                                item.relationships = data.relationships;
                                item.keys = data.keys;
                                setted = true;
                            }
                        });
                        if (!setted) {
                            state[this.schema.pluralize(model)].push(data);
                        }
                    } else {
                        state[model] = [];
                        state[model] = data;
                        state[model].splice(data.length);
                    }
                },
                updateField: (state, { path, value }) => {
                    //set in field
                    path.split(/[.[\]]+/).reduce((prev, key, index, array) => {
                        if (array.length === index + 1) {
                            // eslint-disable-next-line no-param-reassign
                            prev[key] = value;
                        }
                        return prev[key];
                    }, state);
                }
            };
        }
    }
}
exports.default = VuexStore;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZ1ZXgtc3RvcmUuanMiXSwibmFtZXMiOlsiVnVleFN0b3JlIiwiU3RvcmUiLCJjb25zdHJ1Y3RvciIsInNldHRpbmdzIiwibmFtZXNwYWNlZCIsInNjaGVtYSIsInN0YXRlIiwiT2JqZWN0Iiwia2V5cyIsIl9zY2hlbWEiLCJtb2RlbHMiLCJmb3JFYWNoIiwidHlwZSIsIm1vZGVsIiwiZ2V0TW9kZWwiLCJzaW5ndWxhcml6ZSIsInBsdXJhbGl6ZSIsImdldHRlcnMiLCJnZXRGaWVsZCIsInBhdGgiLCJzcGxpdCIsInJlZHVjZSIsInByZXYiLCJrZXkiLCJhY3Rpb25zIiwiY3JlYXRlIiwiY29tbWl0IiwiZGlzcGF0Y2giLCJyZWNvcmQiLCJ1cGRhdGUiLCJ0IiwiYWRkUmVjb3JkIiwidGhlbiIsImRhdGEiLCJmZXRjaEFsbE9mIiwicXVlcnkiLCJxIiwiZmluZFJlY29yZHMiLCJmZXRjaEFsbFJlbGF0ZWRPZiIsImZpbmRSZWxhdGVkUmVjb3JkcyIsInJlbGF0aW9uc2hpcCIsImZldGNoUmVsYXRlZE9mIiwiZmluZFJlbGF0ZWRSZWNvcmQiLCJmZXRjaE9uZSIsImlkIiwiZmluZFJlY29yZCIsInVwZGF0ZVJlY29yZCIsImRlbGV0ZSIsInJlbW92ZVJlY29yZCIsInVwZGF0aW5nIiwic3RvcmUiLCJvcHRpb25zIiwidHJhbnNmb3JtT3JPcGVyYXRpb25zIiwidGhlbmFibGUiLCJxdWVyeWluZyIsInF1ZXJ5T3JFeHByZXNzaW9uIiwibXV0YXRpb25zIiwicmVtb3ZlIiwibGFzdEluZGV4T2YiLCJsZW5ndGgiLCJpbmRleCIsImZpbmRJbmRleCIsInNwbGljZSIsInNldCIsInNldHRlZCIsIml0ZW0iLCJhdHRyaWJ1dGVzIiwicmVsYXRpb25zaGlwcyIsInB1c2giLCJ1cGRhdGVGaWVsZCIsInZhbHVlIiwiYXJyYXkiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBOzs7Ozs7QUFDZSxNQUFNQSxTQUFOLFNBQXdCQyxlQUF4QixDQUE4QjtBQUN6Q0MsZ0JBQVlD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T0g7QUF4Q1ksYUFBakI7QUEwQ0g7QUFDSjtBQTFId0M7a0JBQXhCTixTIiwiZmlsZSI6InZ1ZXgtc3RvcmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU3RvcmUgZnJvbSAnQG9yYml0L3N0b3JlJztcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFZ1ZXhTdG9yZSBleHRlbmRzIFN0b3JlIHtcbiAgICBjb25zdHJ1Y3RvcihzZXR0aW5ncyA9IHt9KSB7XG4gICAgICAgIHN1cGVyKHNldHRpbmdzKTtcbiAgICAgICAgdGhpcy5uYW1lc3BhY2VkID0gZmFsc2U7XG4gICAgICAgIGlmIChzZXR0aW5ncy5zY2hlbWEpIHtcbiAgICAgICAgICAgIC8vZ2VuZXJhdGUgdnVleCBzdG9yZVxuICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IHRoaXMuc3RhdGUgfHwge307XG4gICAgICAgICAgICBPYmplY3Qua2V5cyh0aGlzLl9zY2hlbWEubW9kZWxzKS5mb3JFYWNoKHR5cGUgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBtb2RlbCA9IHNldHRpbmdzLnNjaGVtYS5nZXRNb2RlbCh0eXBlKTtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gdGhpcy5zdGF0ZSB8fCB7fTtcbiAgICAgICAgICAgICAgICAvL2FkZCB0byBzdGF0ZVxuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGVbdGhpcy5fc2NoZW1hLnNpbmd1bGFyaXplKHR5cGUpXSA9IG51bGw7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZVt0aGlzLl9zY2hlbWEucGx1cmFsaXplKHR5cGUpXSA9IFtdO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAvL21hcCBmaWVsZHNcbiAgICAgICAgICAgIHRoaXMuZ2V0dGVycyA9IHtcbiAgICAgICAgICAgICAgICBnZXRGaWVsZDogc3RhdGUgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGF0aCA9PiBwYXRoLnNwbGl0KC9bLltcXF1dKy8pLnJlZHVjZSgocHJldiwga2V5KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJldiAhPSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByZXZba2V5XTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0sIHN0YXRlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGhpcy5hY3Rpb25zID0ge1xuICAgICAgICAgICAgICAgIC8vVE9ETzogQWRkIGZldGNoIHNldHRpbmdzIGxpa2UganNvbiBhcGlcbiAgICAgICAgICAgICAgICBjcmVhdGU6ICh7IGNvbW1pdCwgZGlzcGF0Y2ggfSwgcmVjb3JkKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlKHQgPT4gdC5hZGRSZWNvcmQocmVjb3JkKSkudGhlbihkYXRhID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRpc3BhdGNoKFwiZmV0Y2hBbGxPZlwiLCByZWNvcmQudHlwZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb21taXQoXCJzZXRcIiwgeyBkYXRhOiByZWNvcmQsIG1vZGVsOiB0aGlzLl9zY2hlbWEuc2luZ3VsYXJpemUocmVjb3JkLnR5cGUpIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy9UT0RPOiByZWxhdGlvbnNoaXBzIFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICAgICAqIEBhcmd1bWVudCBtb2RlbDogVGhlIG1vZGVsIGFzIHNpbmd1bGFyaXplZCBuYW1lXG4gICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgZmV0Y2hBbGxPZjogKHsgY29tbWl0IH0sIG1vZGVsKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucXVlcnkocSA9PiBxLmZpbmRSZWNvcmRzKG1vZGVsKSkudGhlbihkYXRhID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1pdCgnc2V0JywgeyBkYXRhLCBtb2RlbDogdGhpcy5fc2NoZW1hLnBsdXJhbGl6ZShtb2RlbCkgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZmV0Y2hBbGxSZWxhdGVkT2Y6ICh7IGNvbW1pdCB9LCBxdWVyeSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXJ5KHEgPT4gcS5maW5kUmVsYXRlZFJlY29yZHMocXVlcnkuZGF0YSwgcXVlcnkucmVsYXRpb25zaGlwKSkudGhlbihkYXRhID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1pdCgnc2V0JywgeyBkYXRhLCBtb2RlbDogcXVlcnkucmVsYXRpb25zaGlwIH0pO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGZldGNoUmVsYXRlZE9mOiAoeyBjb21taXQgfSwgcXVlcnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5xdWVyeShxID0+IHEuZmluZFJlbGF0ZWRSZWNvcmQocXVlcnkuZGF0YSwgcXVlcnkucmVsYXRpb25zaGlwKSkudGhlbihkYXRhID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1pdCgnc2V0JywgeyBkYXRhLCBtb2RlbDogcXVlcnkucmVsYXRpb25zaGlwIH0pO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGZldGNoT25lOiAoeyBjb21taXQgfSwgeyBtb2RlbCwgaWQgfSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXJ5KHEgPT4gcS5maW5kUmVjb3JkKHsgdHlwZTogbW9kZWwsIGlkIH0pKS50aGVuKGRhdGEgPT4gY29tbWl0KCdzZXQnLCB7IGRhdGEsIG1vZGVsOiB0aGlzLl9zY2hlbWEuc2luZ3VsYXJpemUobW9kZWwpIH0pKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHVwZGF0ZTogKHsgY29tbWl0IH0sIGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGUodCA9PiB0LnVwZGF0ZVJlY29yZChkYXRhKSkudGhlbigoKSA9PiBjb21taXQoJ3NldCcsIHsgZGF0YSwgbW9kZWw6IGRhdGEudHlwZSB9KSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBkZWxldGU6ICh7IGNvbW1pdCwgZGlzcGF0Y2ggfSwgZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZSh0ID0+IHQucmVtb3ZlUmVjb3JkKGRhdGEpKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vdXBkYXRlXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNwYXRjaChcImZldGNoQWxsT2ZcIiwgZGF0YS50eXBlKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB1cGRhdGluZzogKHN0b3JlLCBvcHRpb25zKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlKG9wdGlvbnMudHJhbnNmb3JtT3JPcGVyYXRpb25zKS50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy50aGVuYWJsZShzdG9yZSwgZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgcXVlcnlpbmc6IChzdG9yZSwgb3B0aW9ucykgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXJ5KHEgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnMucXVlcnlPckV4cHJlc3Npb24ocSk7XG4gICAgICAgICAgICAgICAgICAgIH0pLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnRoZW5hYmxlKHN0b3JlLCBkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vVE9ETzogUmVsYXRlZFJlY29yZHMgdXBkYXRlIGFuZCBkZWxldGVcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLm11dGF0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICByZW1vdmU6IChzdGF0ZSwgeyBkYXRhLCBtb2RlbCB9KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtb2RlbC5sYXN0SW5kZXhPZigncycpICE9PSBtb2RlbC5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgaW5kZXggPSBzdGF0ZVttb2RlbCArICdzJ10uZmluZEluZGV4KHJlY29yZCA9PiByZWNvcmQuaWQgPT0gZGF0YS5pZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZVttb2RlbCArICdzJ10uc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpbmRleCA9IHN0YXRlW21vZGVsICsgJ3MnXS5maW5kSW5kZXgocmVjb3JkID0+IHJlY29yZC5pZCA9PSBkYXRhLmlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlW21vZGVsICsgJ3MnXS5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBzZXQ6IChzdGF0ZSwgeyBkYXRhLCBtb2RlbCB9KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlW21vZGVsXSA9IGRhdGE7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtb2RlbC5sYXN0SW5kZXhPZigncycpICE9PSBtb2RlbC5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgc2V0dGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZVt0aGlzLnNjaGVtYS5wbHVyYWxpemUobW9kZWwpXS5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmlkID09PSBkYXRhLmlkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0uYXR0cmlidXRlcyA9IGRhdGEuYXR0cmlidXRlcztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5yZWxhdGlvbnNoaXBzID0gZGF0YS5yZWxhdGlvbnNoaXBzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLmtleXMgPSBkYXRhLmtleXM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldHRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXNldHRlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlW3RoaXMuc2NoZW1hLnBsdXJhbGl6ZShtb2RlbCldLnB1c2goZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZVttb2RlbF0gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlW21vZGVsXSA9IGRhdGE7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZVttb2RlbF0uc3BsaWNlKGRhdGEubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgdXBkYXRlRmllbGQ6IChzdGF0ZSwgeyBwYXRoLCB2YWx1ZSB9KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIC8vc2V0IGluIGZpZWxkXG4gICAgICAgICAgICAgICAgICAgIHBhdGguc3BsaXQoL1suW1xcXV0rLykucmVkdWNlKChwcmV2LCBrZXksIGluZGV4LCBhcnJheSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFycmF5Lmxlbmd0aCA9PT0gaW5kZXggKyAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXBhcmFtLXJlYXNzaWduXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldltrZXldID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJldltrZXldO1xuICAgICAgICAgICAgICAgICAgICB9LCBzdGF0ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgIH1cbn0iXX0=